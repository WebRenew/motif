{
  "markdown": "[Vercel](https://vercel.com/) Slash [Workflow DevKit LogoWorkflow](https://useworkflow.dev/)\n\n- [Docs](https://useworkflow.dev/docs)\n- [Examples](https://github.com/vercel/workflow-examples)\n\n[X](https://x.com/workflowdevkit) [GitHub](https://github.com/vercel/workflow) Search... `⌘K`Ask AI\n\nAsk AI\n\nSearch... `⌘K`\n\n[Getting Started](https://useworkflow.dev/docs/getting-started)\n\n- [Next.js](https://useworkflow.dev/docs/getting-started/next)\n- [Vite](https://useworkflow.dev/docs/getting-started/vite)\n- [Astro](https://useworkflow.dev/docs/getting-started/astro)\n- [Express](https://useworkflow.dev/docs/getting-started/express)\n- [Fastify](https://useworkflow.dev/docs/getting-started/fastify)\n- [Hono](https://useworkflow.dev/docs/getting-started/hono)\n- [Nitro](https://useworkflow.dev/docs/getting-started/nitro)\n- [Nuxt](https://useworkflow.dev/docs/getting-started/nuxt)\n- [SvelteKit](https://useworkflow.dev/docs/getting-started/sveltekit)\n\n[Foundations](https://useworkflow.dev/docs/foundations)\n\n- [Workflows and Steps](https://useworkflow.dev/docs/foundations/workflows-and-steps)\n- [Starting Workflows](https://useworkflow.dev/docs/foundations/starting-workflows)\n- [Control Flow Patterns](https://useworkflow.dev/docs/foundations/control-flow-patterns)\n- [Errors & Retrying](https://useworkflow.dev/docs/foundations/errors-and-retries)\n- [Hooks & Webhooks](https://useworkflow.dev/docs/foundations/hooks)\n- [Streaming](https://useworkflow.dev/docs/foundations/streaming)\n- [Serialization](https://useworkflow.dev/docs/foundations/serialization)\n- [Idempotency](https://useworkflow.dev/docs/foundations/idempotency)\n\nHow it works\n\n[Observability](https://useworkflow.dev/docs/observability)\n\nAI Agents\n\n- [Building Durable AI Agents](https://useworkflow.dev/docs/ai)\n- [Streaming Updates from Tools](https://useworkflow.dev/docs/ai/streaming-updates-from-tools)\n- [Resumable Streams](https://useworkflow.dev/docs/ai/resumable-streams)\n- [Sleep, Suspense, and Scheduling](https://useworkflow.dev/docs/ai/sleep-and-delays)\n- [Human-in-the-Loop](https://useworkflow.dev/docs/ai/human-in-the-loop)\n- [Patterns for Defining Tools](https://useworkflow.dev/docs/ai/defining-tools)\n- [Chat Session Modeling](https://useworkflow.dev/docs/ai/chat-session-modeling)\n\n[Deploying](https://useworkflow.dev/docs/deploying)\n\n[Errors](https://useworkflow.dev/docs/errors)\n\n[API Reference](https://useworkflow.dev/docs/api-reference)\n\nEvent SourcingEvent Sourcing Overview\n\nHow it works\n\n# Event Sourcing\n\nThis guide explores how the Workflow DevKit uses event sourcing internally. Understanding these concepts is helpful for debugging and building observability tools, but is not required to use workflows. For getting started with workflows, see the [getting started](https://useworkflow.dev/docs/getting-started) guides for your framework.\n\nThe Workflow DevKit uses event sourcing to track all state changes in workflow executions. Every mutation creates an event that is persisted to the event log, and entity state is derived by replaying these events.\n\nThis page explains the event sourcing model and entity lifecycles.\n\n## [Event Sourcing Overview](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#event-sourcing-overview)\n\nEvent sourcing is a persistence pattern where state changes are stored as a sequence of events rather than by updating records in place. The current state of any entity is reconstructed by replaying its events from the beginning.\n\n**Benefits for durable workflows:**\n\n- **Complete audit trail**: Every state change is recorded with its timestamp and context\n- **Debugging**: Replay the exact sequence of events that led to any state\n- **Consistency**: Events provide a single source of truth for all entity state\n- **Recoverability**: State can be reconstructed from the event log after failures\n\nIn the Workflow DevKit, the following entity types are managed through events:\n\n- **Runs**: Workflow execution instances (materialized in storage)\n- **Steps**: Individual atomic operations within a workflow (materialized in storage)\n- **Hooks**: Suspension points that can receive external data (materialized in storage)\n- **Waits**: Sleep or delay operations (tracked via events only, not materialized)\n\n## [Entity Lifecycles](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#entity-lifecycles)\n\nEach entity type follows a specific lifecycle defined by the events that can affect it. Events transition entities between states, and certain states are terminal—once reached, no further transitions are possible.\n\nIn the diagrams below, purple nodes indicate terminal states that cannot be transitioned out of.\n\n### [Run Lifecycle](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#run-lifecycle)\n\nA run represents a single execution of a workflow function. Runs begin in `pending` state when created, transition to `running` when execution starts, and end in one of three terminal states.\n\nrun\\_created\n\nrun\\_started\n\nrun\\_completed\n\nrun\\_failed\n\nrun\\_cancelled\n\nrun\\_cancelled\n\n(start)\n\npending\n\nrunning\n\ncompleted\n\nfailed\n\ncancelled\n\n**Run states:**\n\n- `pending`: Created but not yet executing\n- `running`: Actively executing workflow code\n- `completed`: Finished successfully with an output value\n- `failed`: Terminated due to an unrecoverable error\n- `cancelled`: Explicitly cancelled by the user or system\n\n### [Step Lifecycle](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#step-lifecycle)\n\nA step represents a single invocation of a step function. Steps can retry on failure, either transitioning back to `pending` via `step_retrying` or being re-executed directly with another `step_started` event.\n\nstep\\_created\n\nstep\\_started\n\nstep\\_completed\n\nstep\\_failed\n\nstep\\_retrying\n\n(start)\n\npending\n\nrunning\n\ncompleted\n\nfailed\n\n**Step states:**\n\n- `pending`: Created but not yet executing, or waiting to retry\n- `running`: Actively executing step code\n- `completed`: Finished successfully with a result value\n- `failed`: Terminated after exhausting all retry attempts\n- `cancelled`: Reserved for future use (not currently emitted)\n\nThe `step_retrying` event is optional. Steps can retry without it - the retry mechanism works regardless of whether this event is emitted. You may see back-to-back `step_started` events in logs when a step retries after a timeout or when the error is not explicitly captured. See [Errors and Retries](https://useworkflow.dev/docs/foundations/errors-and-retries) for more on how retries work.\n\nWhen present, the `step_retrying` event moves a step back to `pending` state and records the error that caused the retry. This provides two benefits:\n\n- **Cleaner observability**: The event log explicitly shows retry transitions rather than consecutive `step_started` events\n- **Error history**: The error that triggered the retry is preserved for debugging\n\n### [Hook Lifecycle](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#hook-lifecycle)\n\nA hook represents a suspension point that can receive external data, created by [`createHook()`](https://useworkflow.dev/docs/api-reference/workflow/create-hook). Hooks enable workflows to pause and wait for external events, user interactions, or HTTP requests. Webhooks (created with [`createWebhook()`](https://useworkflow.dev/docs/api-reference/workflow/create-webhook)) are a higher-level abstraction built on hooks that adds automatic HTTP request/response handling.\n\nHooks can receive multiple payloads while active and are disposed when no longer needed.\n\nhook\\_created\n\nhook\\_conflict\n\nhook\\_received\n\nhook\\_disposed\n\n(start)\n\nactive\n\nconflicted\n\ndisposed\n\n**Hook states:**\n\n- `active`: Ready to receive payloads (hook exists in storage)\n- `disposed`: No longer accepting payloads (hook is deleted from storage)\n- `conflicted`: Hook creation failed because the token is already in use by another workflow\n\nUnlike other entities, hooks don't have a `status` field—the states above are conceptual. An \"active\" hook is one that exists in storage, while \"disposed\" means the hook has been deleted. When a `hook_disposed` event is created, the hook record is removed rather than updated.\n\nWhile a hook is active, its token is reserved and cannot be used by other workflows. If a workflow attempts to create a hook with a token that is already in use by another active hook, a `hook_conflict` event is recorded instead of `hook_created`. This causes the hook's promise to reject with a `WorkflowRuntimeError`, failing the workflow gracefully. See the [hook-conflict error](https://useworkflow.dev/docs/errors/hook-conflict) documentation for more details.\n\nWhen a hook is disposed (either explicitly or when its workflow completes), the token is released and can be claimed by future workflows. Hooks are automatically disposed when a workflow reaches a terminal state (`completed`, `failed`, or `cancelled`). The `hook_disposed` event is only needed for explicit disposal before workflow completion.\n\nSee [Hooks & Webhooks](https://useworkflow.dev/docs/foundations/hooks) for more on how hooks and webhooks work.\n\n### [Wait Lifecycle](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#wait-lifecycle)\n\nA wait represents a sleep operation created by [`sleep()`](https://useworkflow.dev/docs/api-reference/workflow/sleep). Waits track when a delay period has elapsed.\n\nwait\\_created\n\nwait\\_completed\n\n(start)\n\nwaiting\n\ncompleted\n\n**Wait states:**\n\n- `waiting`: Delay period has not yet elapsed\n- `completed`: Delay period has elapsed, workflow can resume\n\nUnlike Runs, Steps, and Hooks, waits are conceptual entities tracked only through events. There is no separate \"Wait\" record in storage that can be queried—the wait state is derived entirely from the `wait_created` and `wait_completed` events in the event log.\n\n## [Event Types Reference](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#event-types-reference)\n\nEvents are categorized by the entity type they affect. Each event contains metadata including a timestamp and a `correlationId` that links the event to a specific entity:\n\n- Step events use the `stepId` as the correlation ID\n- Hook events use the `hookId` as the correlation ID\n- Wait events use the `waitId` as the correlation ID\n- Run events do not require a correlation ID since the `runId` itself identifies the entity\n\n### [Run Events](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#run-events)\n\n| Event | Description |\n| --- | --- |\n| `run_created` | Creates a new workflow run in `pending` state. Contains the deployment ID, workflow name, input arguments, and optional execution context. |\n| `run_started` | Transitions the run to `running` state when execution begins. |\n| `run_completed` | Transitions the run to `completed` state with the workflow's return value. |\n| `run_failed` | Transitions the run to `failed` state with error details and optional error code. |\n| `run_cancelled` | Transitions the run to `cancelled` state. Can be triggered from `pending` or `running` states. |\n\n### [Step Events](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#step-events)\n\n| Event | Description |\n| --- | --- |\n| `step_created` | Creates a new step in `pending` state. Contains the step name and serialized input arguments. |\n| `step_started` | Transitions the step to `running` state. Includes the current attempt number for retries. |\n| `step_completed` | Transitions the step to `completed` state with the step's return value. |\n| `step_failed` | Transitions the step to `failed` state with error details. The step will not be retried. |\n| `step_retrying` | (Optional) Transitions the step back to `pending` state for retry. Contains the error that caused the retry and optional delay before the next attempt. When not emitted, retries appear as consecutive `step_started` events. |\n\n### [Hook Events](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#hook-events)\n\n| Event | Description |\n| --- | --- |\n| `hook_created` | Creates a new hook in `active` state. Contains the hook token and optional metadata. |\n| `hook_conflict` | Records that hook creation failed because the token is already in use by another active hook. The hook is not created, and the workflow will fail with a `WorkflowRuntimeError` when the hook is awaited. |\n| `hook_received` | Records that a payload was delivered to the hook. The hook remains `active` and can receive more payloads. |\n| `hook_disposed` | Deletes the hook from storage (conceptually transitioning to `disposed` state). The token is released for reuse by future workflows. |\n\n### [Wait Events](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#wait-events)\n\n| Event | Description |\n| --- | --- |\n| `wait_created` | Creates a new wait in `waiting` state. Contains the timestamp when the wait should complete. |\n| `wait_completed` | Transitions the wait to `completed` state when the delay period has elapsed. |\n\n## [Terminal States](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#terminal-states)\n\nTerminal states represent the end of an entity's lifecycle. Once an entity reaches a terminal state, no further events can transition it to another state.\n\n**Run terminal states:**\n\n- `completed`: Workflow finished successfully\n- `failed`: Workflow encountered an unrecoverable error\n- `cancelled`: Workflow was explicitly cancelled\n\n**Step terminal states:**\n\n- `completed`: Step finished successfully\n- `failed`: Step failed after all retry attempts\n\n**Hook terminal states:**\n\n- `disposed`: Hook has been deleted from storage and is no longer active\n- `conflicted`: Hook creation failed due to token conflict (hook was never created)\n\n**Wait terminal states:**\n\n- `completed`: Delay period has elapsed\n\nAttempting to create an event that would transition an entity out of a terminal state will result in an error. This prevents inconsistent state and ensures the integrity of the event log.\n\n## [Event Correlation](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#event-correlation)\n\nEvents use a `correlationId` to link related events together. For step, hook, and wait events, the correlation ID identifies the specific entity instance:\n\n- Step events share the same `correlationId` (the step ID) across all events for that step execution\n- Hook events share the same `correlationId` (the hook ID) across all events for that hook\n- Wait events share the same `correlationId` (the wait ID) across creation and completion\n\nRun events do not require a correlation ID since the `runId` itself provides the correlation.\n\nThis correlation enables:\n\n- Querying all events for a specific step, hook, or wait\n- Building timelines of entity lifecycle transitions\n- Debugging by tracing the complete history of any entity\n\n## [Entity IDs](https://useworkflow.dev/docs/how-it-works/event-sourcing\\#entity-ids)\n\nAll entities in the Workflow DevKit use a consistent ID format: a 4-character prefix followed by an underscore and a [ULID](https://github.com/ulid/spec) (Universally Unique Lexicographically Sortable Identifier).\n\n| Entity | Prefix | Example |\n| --- | --- | --- |\n| Run | `wrun_` | `wrun_01HXYZ123ABC456DEF789GHJ` |\n| Step | `step_` | `step_01HXYZ123ABC456DEF789GHJ` |\n| Hook | `hook_` | `hook_01HXYZ123ABC456DEF789GHJ` |\n| Wait | `wait_` | `wait_01HXYZ123ABC456DEF789GHJ` |\n| Event | `evnt_` | `evnt_01HXYZ123ABC456DEF789GHJ` |\n| Stream | `strm_` | `strm_01HXYZ123ABC456DEF789GHJ` |\n\n**Why this format?**\n\n- **Prefixes enable introspection**: Given any ID, you can immediately identify what type of entity it refers to. This makes debugging, logging, and cross-referencing entities across the system straightforward.\n\n- **ULIDs enable chronological ordering**: Unlike UUIDs, ULIDs encode a timestamp in their first 48 bits, making them lexicographically sortable by creation time. This property is essential for the event log—events are always stored and retrieved in the correct chronological order simply by sorting their IDs.\n\n\n[Framework Integrations\\\\\n\\\\\nPrevious Page](https://useworkflow.dev/docs/how-it-works/framework-integrations) [Observability\\\\\n\\\\\nNext Page](https://useworkflow.dev/docs/observability)\n\nOn this page\n\n[Event Sourcing Overview](https://useworkflow.dev/docs/how-it-works/event-sourcing#event-sourcing-overview) [Entity Lifecycles](https://useworkflow.dev/docs/how-it-works/event-sourcing#entity-lifecycles) [Run Lifecycle](https://useworkflow.dev/docs/how-it-works/event-sourcing#run-lifecycle) [Step Lifecycle](https://useworkflow.dev/docs/how-it-works/event-sourcing#step-lifecycle) [Hook Lifecycle](https://useworkflow.dev/docs/how-it-works/event-sourcing#hook-lifecycle) [Wait Lifecycle](https://useworkflow.dev/docs/how-it-works/event-sourcing#wait-lifecycle) [Event Types Reference](https://useworkflow.dev/docs/how-it-works/event-sourcing#event-types-reference) [Run Events](https://useworkflow.dev/docs/how-it-works/event-sourcing#run-events) [Step Events](https://useworkflow.dev/docs/how-it-works/event-sourcing#step-events) [Hook Events](https://useworkflow.dev/docs/how-it-works/event-sourcing#hook-events) [Wait Events](https://useworkflow.dev/docs/how-it-works/event-sourcing#wait-events) [Terminal States](https://useworkflow.dev/docs/how-it-works/event-sourcing#terminal-states) [Event Correlation](https://useworkflow.dev/docs/how-it-works/event-sourcing#event-correlation) [Entity IDs](https://useworkflow.dev/docs/how-it-works/event-sourcing#entity-ids)\n\n[GitHubEdit this page on GitHub](https://github.com/vercel/workflow/edit/main/content/docs/how-it-works/event-sourcing.mdx) Scroll to topGive feedbackCopy pageAsk AI about this pageOpen in chat\n\n## Chat\n\nWhat is Workflow?How does retrying work?What control flow patterns are there?How do directives work?How do I build an AI agent?\n\nTip: You can open and close chat with `⌘I`\n\n0 / 1000",
  "metadata": {
    "next-size-adjust": "",
    "twitter:title": "Event Sourcing",
    "ogImage": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "ogTitle": "Event Sourcing",
    "og:image:type": "image/png",
    "language": "en",
    "viewport": "width=device-width, initial-scale=1",
    "og:image:width": "1200",
    "title": "Event Sourcing",
    "twitter:image": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "twitter:image:height": "628",
    "og:image:height": "628",
    "twitter:image:type": "image/png",
    "og:image": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "og:title": "Event Sourcing",
    "twitter:image:width": "1200",
    "twitter:card": "summary_large_image",
    "favicon": "https://useworkflow.dev/favicon.ico?favicon.e7ce0d1c.ico",
    "scrapeId": "019bf2d4-57d5-727e-b359-e1551db6973a",
    "sourceURL": "https://useworkflow.dev/docs/how-it-works/event-sourcing",
    "url": "https://useworkflow.dev/docs/how-it-works/event-sourcing",
    "statusCode": 200,
    "contentType": "text/html; charset=utf-8",
    "timezone": "America/New_York",
    "proxyUsed": "basic",
    "cacheState": "miss",
    "indexId": "6e3e8dd7-e03a-44a8-9163-4f19e6b96a9c",
    "creditsUsed": 1
  }
}