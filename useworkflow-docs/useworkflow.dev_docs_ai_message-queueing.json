{
  "markdown": "[Vercel](https://vercel.com/) Slash [Workflow DevKit LogoWorkflow](https://useworkflow.dev/)\n\n- [Docs](https://useworkflow.dev/docs)\n- [Examples](https://github.com/vercel/workflow-examples)\n\n[X](https://x.com/workflowdevkit) [GitHub](https://github.com/vercel/workflow) Search... `⌘K`Ask AI\n\nAsk AI\n\nSearch... `⌘K`\n\n[Getting Started](https://useworkflow.dev/docs/getting-started)\n\n- [Next.js](https://useworkflow.dev/docs/getting-started/next)\n- [Vite](https://useworkflow.dev/docs/getting-started/vite)\n- [Astro](https://useworkflow.dev/docs/getting-started/astro)\n- [Express](https://useworkflow.dev/docs/getting-started/express)\n- [Fastify](https://useworkflow.dev/docs/getting-started/fastify)\n- [Hono](https://useworkflow.dev/docs/getting-started/hono)\n- [Nitro](https://useworkflow.dev/docs/getting-started/nitro)\n- [Nuxt](https://useworkflow.dev/docs/getting-started/nuxt)\n- [SvelteKit](https://useworkflow.dev/docs/getting-started/sveltekit)\n\n[Foundations](https://useworkflow.dev/docs/foundations)\n\n- [Workflows and Steps](https://useworkflow.dev/docs/foundations/workflows-and-steps)\n- [Starting Workflows](https://useworkflow.dev/docs/foundations/starting-workflows)\n- [Control Flow Patterns](https://useworkflow.dev/docs/foundations/control-flow-patterns)\n- [Errors & Retrying](https://useworkflow.dev/docs/foundations/errors-and-retries)\n- [Hooks & Webhooks](https://useworkflow.dev/docs/foundations/hooks)\n- [Streaming](https://useworkflow.dev/docs/foundations/streaming)\n- [Serialization](https://useworkflow.dev/docs/foundations/serialization)\n- [Idempotency](https://useworkflow.dev/docs/foundations/idempotency)\n\nHow it works\n\n[Observability](https://useworkflow.dev/docs/observability)\n\nAI Agents\n\n- [Building Durable AI Agents](https://useworkflow.dev/docs/ai)\n- [Streaming Updates from Tools](https://useworkflow.dev/docs/ai/streaming-updates-from-tools)\n- [Resumable Streams](https://useworkflow.dev/docs/ai/resumable-streams)\n- [Sleep, Suspense, and Scheduling](https://useworkflow.dev/docs/ai/sleep-and-delays)\n- [Human-in-the-Loop](https://useworkflow.dev/docs/ai/human-in-the-loop)\n- [Patterns for Defining Tools](https://useworkflow.dev/docs/ai/defining-tools)\n- [Chat Session Modeling](https://useworkflow.dev/docs/ai/chat-session-modeling)\n\n[Deploying](https://useworkflow.dev/docs/deploying)\n\n[Errors](https://useworkflow.dev/docs/errors)\n\n[API Reference](https://useworkflow.dev/docs/api-reference)\n\nQueueing User MessagesWhen to Use This\n\nAi\n\n# Queueing User Messages\n\nWhen using [multi-turn workflows](https://useworkflow.dev/docs/ai/chat-session-modeling#multi-turn-workflows), messages typically arrive between agent turns. The workflow waits at a hook, receives a message, then starts a new turn. But sometimes you need to inject messages _during_ an agent's turn, before tool calls complete or while the model is reasoning.\n\n`DurableAgent`'s `prepareStep` callback enables this by running before each step in the agent loop, giving you a chance to inject queued messages into the conversation. `prepareStep` also allows you to modify the model choice and existing messages mid-turn, see AI SDK's [prepareStep callback](https://ai-sdk.dev/docs/agents/loop-control#prepare-step) for more details.\n\n## [When to Use This](https://useworkflow.dev/docs/ai/message-queueing\\#when-to-use-this)\n\nMessage queueing is useful when:\n\n- Users send follow-up messages while the agent is still searching for flights or processing bookings\n- External systems need to inject context mid-turn (e.g., a flight status webhook fires during processing)\n- You want messages to influence the agent's next step rather than waiting for the current turn to complete\n\nIf you just need basic multi-turn conversations where messages arrive between turns, see [Chat Session Modeling](https://useworkflow.dev/docs/ai/chat-session-modeling). This guide covers the more advanced case of injecting messages _during_ turns.\n\n## [The `prepareStep` Callback](https://useworkflow.dev/docs/ai/message-queueing\\#the-preparestep-callback)\n\nThe `prepareStep` callback runs before each step in the agent loop. It receives the current state and can modify the messages sent to the model:\n\n```\ninterface PrepareStepInfo {\n  model: string | (() => Promise<LanguageModelV2>);  // Current model\n  stepNumber: number;                                // 0-indexed step count\n  steps: StepResult[];                               // Previous step results\n  messages: LanguageModelV2Prompt;                   // Messages to be sent\n}\n\ninterface PrepareStepResult {\n  model?: string | (() => Promise<LanguageModelV2>); // Override model\n  messages?: LanguageModelV2Prompt;                  // Override messages\n}\n```\n\n## [Injecting Queued Messages](https://useworkflow.dev/docs/ai/message-queueing\\#injecting-queued-messages)\n\nOnce you have a [multi-turn workflow](https://useworkflow.dev/docs/ai/chat-session-modeling#multi-turn-workflows), you can combine a message queue with `prepareStep` to inject messages that arrive during processing:\n\nworkflows/chat/index.ts\n\n```\n\n```\n\nMessages sent via `chatMessageHook.resume()` accumulate in the queue and get injected before the next step, whether that's a tool call or another LLM request.\n\nThe `prepareStep` callback receives messages in `LanguageModelV2Prompt` format (with content arrays), which is the internal format used by the AI SDK.\n\n## [Combining with Multi-Turn Sessions](https://useworkflow.dev/docs/ai/message-queueing\\#combining-with-multi-turn-sessions)\n\nYou can also combine message queueing with the standard multi-turn pattern:\n\nworkflows/chat/index.ts\n\n```\n\n```\n\n## [Related Documentation](https://useworkflow.dev/docs/ai/message-queueing\\#related-documentation)\n\n- [Chat Session Modeling](https://useworkflow.dev/docs/ai/chat-session-modeling) \\- Single-turn vs multi-turn patterns\n- [Building Durable AI Agents](https://useworkflow.dev/docs/ai) \\- Complete guide to creating durable agents\n- [`DurableAgent` API Reference](https://useworkflow.dev/docs/api-reference/workflow-ai/durable-agent) \\- Full API documentation\n- [`defineHook()` API Reference](https://useworkflow.dev/docs/api-reference/workflow/define-hook) \\- Hook configuration options\n\nOn this page\n\n[When to Use This](https://useworkflow.dev/docs/ai/message-queueing#when-to-use-this) [The `prepareStep` Callback](https://useworkflow.dev/docs/ai/message-queueing#the-preparestep-callback) [Injecting Queued Messages](https://useworkflow.dev/docs/ai/message-queueing#injecting-queued-messages) [Combining with Multi-Turn Sessions](https://useworkflow.dev/docs/ai/message-queueing#combining-with-multi-turn-sessions) [Related Documentation](https://useworkflow.dev/docs/ai/message-queueing#related-documentation)\n\n[GitHubEdit this page on GitHub](https://github.com/vercel/workflow/edit/main/content/docs/ai/message-queueing.mdx) Scroll to topGive feedbackCopy pageAsk AI about this pageOpen in chat\n\n## Chat\n\nWhat is Workflow?How does retrying work?What control flow patterns are there?How do directives work?How do I build an AI agent?\n\nTip: You can open and close chat with `⌘I`\n\n0 / 1000",
  "metadata": {
    "title": "Queueing User Messages",
    "twitter:card": "summary_large_image",
    "twitter:title": "Queueing User Messages",
    "twitter:image:width": "1200",
    "twitter:image:type": "image/png",
    "ogTitle": "Queueing User Messages",
    "ogImage": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "og:title": "Queueing User Messages",
    "og:image": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "twitter:image:height": "628",
    "og:image:height": "628",
    "next-size-adjust": "",
    "language": "en",
    "viewport": "width=device-width, initial-scale=1",
    "og:image:type": "image/png",
    "twitter:image": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "og:image:width": "1200",
    "favicon": "https://useworkflow.dev/favicon.ico?favicon.e7ce0d1c.ico",
    "scrapeId": "019bf2d4-569c-75d7-940f-0cfe2da65b94",
    "sourceURL": "https://useworkflow.dev/docs/ai/message-queueing",
    "url": "https://useworkflow.dev/docs/ai/message-queueing",
    "statusCode": 200,
    "contentType": "text/html; charset=utf-8",
    "proxyUsed": "basic",
    "cacheState": "hit",
    "cachedAt": "2026-01-24T22:00:50.024Z",
    "creditsUsed": 1
  }
}