{
  "markdown": "[Vercel](https://vercel.com/) Slash [Workflow DevKit LogoWorkflow](https://useworkflow.dev/)\n\n- [Docs](https://useworkflow.dev/docs)\n- [Examples](https://github.com/vercel/workflow-examples)\n\n[X](https://x.com/workflowdevkit) [GitHub](https://github.com/vercel/workflow) Search... `⌘K`Ask AI\n\nAsk AI\n\nSearch... `⌘K`\n\n[Getting Started](https://useworkflow.dev/docs/getting-started)\n\n- [Next.js](https://useworkflow.dev/docs/getting-started/next)\n- [Vite](https://useworkflow.dev/docs/getting-started/vite)\n- [Astro](https://useworkflow.dev/docs/getting-started/astro)\n- [Express](https://useworkflow.dev/docs/getting-started/express)\n- [Fastify](https://useworkflow.dev/docs/getting-started/fastify)\n- [Hono](https://useworkflow.dev/docs/getting-started/hono)\n- [Nitro](https://useworkflow.dev/docs/getting-started/nitro)\n- [Nuxt](https://useworkflow.dev/docs/getting-started/nuxt)\n- [SvelteKit](https://useworkflow.dev/docs/getting-started/sveltekit)\n\n[Foundations](https://useworkflow.dev/docs/foundations)\n\n- [Workflows and Steps](https://useworkflow.dev/docs/foundations/workflows-and-steps)\n- [Starting Workflows](https://useworkflow.dev/docs/foundations/starting-workflows)\n- [Control Flow Patterns](https://useworkflow.dev/docs/foundations/control-flow-patterns)\n- [Errors & Retrying](https://useworkflow.dev/docs/foundations/errors-and-retries)\n- [Hooks & Webhooks](https://useworkflow.dev/docs/foundations/hooks)\n- [Streaming](https://useworkflow.dev/docs/foundations/streaming)\n- [Serialization](https://useworkflow.dev/docs/foundations/serialization)\n- [Idempotency](https://useworkflow.dev/docs/foundations/idempotency)\n\nHow it works\n\n[Observability](https://useworkflow.dev/docs/observability)\n\nAI Agents\n\n- [Building Durable AI Agents](https://useworkflow.dev/docs/ai)\n- [Streaming Updates from Tools](https://useworkflow.dev/docs/ai/streaming-updates-from-tools)\n- [Resumable Streams](https://useworkflow.dev/docs/ai/resumable-streams)\n- [Sleep, Suspense, and Scheduling](https://useworkflow.dev/docs/ai/sleep-and-delays)\n- [Human-in-the-Loop](https://useworkflow.dev/docs/ai/human-in-the-loop)\n- [Patterns for Defining Tools](https://useworkflow.dev/docs/ai/defining-tools)\n- [Chat Session Modeling](https://useworkflow.dev/docs/ai/chat-session-modeling)\n\n[Deploying](https://useworkflow.dev/docs/deploying)\n\n[Errors](https://useworkflow.dev/docs/errors)\n\n[API Reference](https://useworkflow.dev/docs/api-reference)\n\nIdempotencyThe core pattern: use the step ID as your idempotency key\n\n[Foundations](https://useworkflow.dev/docs/foundations)\n\n# Idempotency\n\nIdempotency is a property of an operation that ensures it can be safely retried without producing duplicate side effects.\n\nIn distributed systems (calling external APIs), it is not always possible to ensure an operation has only been performed once just by seeing if it succeeds.\nConsider a payment API that charges the user $10, but due to network failures, the confirmation response is lost. When the step retries (because the previous attempt was considered a failure), it will charge the user again.\n\nTo prevent this, many external APIs support idempotency keys. An idempotency key is a unique identifier for an operation that can be used to deduplicate requests.\n\n## [The core pattern: use the step ID as your idempotency key](https://useworkflow.dev/docs/foundations/idempotency\\#the-core-pattern-use-the-step-id-as-your-idempotency-key)\n\nEvery step invocation has a stable `stepId` that stays the same across retries.\nUse it as the idempotency key when calling third-party APIs.\n\n```\nimport { getStepMetadata } from \"workflow\";\n\nasync function chargeUser(userId: string, amount: number) {\n  \"use step\";\n\n  const { stepId } = getStepMetadata();\n\n  // Example: Stripe-style idempotency key\n  // This guarantees only one charge is created even if the step retries\n  await stripe.charges.create(\n    {\n      amount,\n      currency: \"usd\",\n      customer: userId,\n    },\n    {\n      idempotencyKey: stepId,\n    }\n  );\n}\n```\n\nWhy this works:\n\n- **Stable across retries**: `stepId` does not change between attempts.\n- **Globally unique per step**: Fulfills the uniqueness requirement for an idempotency key.\n\n## [Best practices](https://useworkflow.dev/docs/foundations/idempotency\\#best-practices)\n\n- **Always provide idempotency keys to external side effects that are not idempotent** inside steps (payments, emails, SMS, queues).\n- **Prefer `stepId` as your key**; it is stable across retries and unique per step.\n- **Keep keys deterministic**; avoid including timestamps or attempt counters.\n- **Handle 409/conflict responses** gracefully; treat them as success if the prior attempt completed.\n\n## [Related docs](https://useworkflow.dev/docs/foundations/idempotency\\#related-docs)\n\n- Learn about retries in [Errors & Retrying](https://useworkflow.dev/docs/foundations/errors-and-retries)\n- API reference: [`getStepMetadata`](https://useworkflow.dev/docs/api-reference/workflow/get-step-metadata)\n\n[Serialization\\\\\n\\\\\nPrevious Page](https://useworkflow.dev/docs/foundations/serialization) [Understanding Directives\\\\\n\\\\\nNext Page](https://useworkflow.dev/docs/how-it-works/understanding-directives)\n\nOn this page\n\n[The core pattern: use the step ID as your idempotency key](https://useworkflow.dev/docs/foundations/idempotency#the-core-pattern-use-the-step-id-as-your-idempotency-key) [Best practices](https://useworkflow.dev/docs/foundations/idempotency#best-practices) [Related docs](https://useworkflow.dev/docs/foundations/idempotency#related-docs)\n\n[GitHubEdit this page on GitHub](https://github.com/vercel/workflow/edit/main/content/docs/foundations/idempotency.mdx) Scroll to topGive feedbackCopy pageAsk AI about this pageOpen in chat\n\n## Chat\n\nWhat is Workflow?How does retrying work?What control flow patterns are there?How do directives work?How do I build an AI agent?\n\nTip: You can open and close chat with `⌘I`\n\n0 / 1000",
  "metadata": {
    "twitter:image:type": "image/png",
    "twitter:image": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "og:title": "Idempotency",
    "og:image:width": "1200",
    "twitter:image:width": "1200",
    "viewport": "width=device-width, initial-scale=1",
    "twitter:image:height": "628",
    "twitter:title": "Idempotency",
    "ogTitle": "Idempotency",
    "twitter:card": "summary_large_image",
    "ogImage": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "og:image": "https://useworkflow.dev/opengraph-image.png?opengraph-image.f38670ff.png",
    "language": "en",
    "og:image:type": "image/png",
    "title": "Idempotency",
    "og:image:height": "628",
    "next-size-adjust": "",
    "favicon": "https://useworkflow.dev/favicon.ico?favicon.e7ce0d1c.ico",
    "scrapeId": "019bf2d4-569c-75d7-940f-d590ca7f570e",
    "sourceURL": "https://useworkflow.dev/docs/foundations/idempotency",
    "url": "https://useworkflow.dev/docs/foundations/idempotency",
    "statusCode": 200,
    "contentType": "text/html; charset=utf-8",
    "proxyUsed": "basic",
    "cacheState": "hit",
    "cachedAt": "2026-01-24T20:00:48.905Z",
    "creditsUsed": 1
  }
}